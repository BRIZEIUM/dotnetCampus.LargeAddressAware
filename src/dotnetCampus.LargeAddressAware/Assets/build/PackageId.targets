<Project>

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <Target Name="dotnetCampus_LargeAddressAware_PrepareProperties">
    <PropertyGroup>
      <dotnetCampus_LargeAddressAware_Root>$(MSBuildThisFileDirectory)..\</dotnetCampus_LargeAddressAware_Root>
      <dotnetCampus_LargeAddressAware_EditBin>$(dotnetCampus_LargeAddressAware_Root)tools\EditBin\editbin.exe</dotnetCampus_LargeAddressAware_EditBin>
      <dotnetCampus_LargeAddressAware_IsNetCoreApp Condition="'$(TargetFrameworkIdentifier)' == '.NETCoreApp'">true</dotnetCampus_LargeAddressAware_IsNetCoreApp>
      <dotnetCampus_LargeAddressAware_IsNetCoreApp Condition="'$(TargetFrameworkIdentifier)' != '.NETCoreApp'">false</dotnetCampus_LargeAddressAware_IsNetCoreApp>
      <dotnetCampus_LargeAddressAware_ShouldEditBin Condition="
                                                    $(LargeAddressAware) == true
                                                    And $(DesignTimeBuild) != true
                                                    And ($(OutputType) == Exe Or $(OutputType) == Winexe)
                                                    And $(PlatformTarget) == x86
                                                    ">true</dotnetCampus_LargeAddressAware_ShouldEditBin>
      <dotnetCampus_LargeAddressAware_ShouldEditBin Condition=" '$(dotnetCampus_LargeAddressAware_ShouldEditBin)' == '' ">false</dotnetCampus_LargeAddressAware_ShouldEditBin>
    </PropertyGroup>
    <Warning Condition=" $(OutputType) != Exe And $(OutputType) != WinExe " Text="生成的程序不是 exe，因此无法开启大内存感知（LargeAddressAware）。" />
    <Message Importance="high" Condition=" $(PlatformTarget) == x86 " Text="生成的程序不是 x86 架构，因此无需开启大内存感知（LargeAddressAware）。" />
    <Message Condition=" $(LargeAddressAware) != true " Text="已通过 LargeAddressAware 属性禁用了 x86 应用程序的大内存感知（LargeAddressAware）。" />
  </Target>

  <!-- .NET Core 的大内存感知 -->
  <Target Name="dotnetCampus_LargeAddressAware_EditNetCoreApp"
          AfterTargets="CoreCompile"
          DependsOnTargets="dotnetCampus_LargeAddressAware_PrepareProperties"
          Condition="$(dotnetCampus_LargeAddressAware_IsNetCoreApp) == true">
  </Target>

  <!-- .NET Framework 的大内存感知 -->
  <Target Name="dotnetCampus_LargeAddressAware_EditNetFrameworkApp"
          AfterTargets="CoreCompile"
          DependsOnTargets="dotnetCampus_LargeAddressAware_PrepareProperties"
          Condition="$(dotnetCampus_LargeAddressAware_IsNetCoreApp) != true">
    <PropertyGroup>
      <dotnetCampus_LargeAddressAware_FinalExeFile>@(IntermediateAssembly)</dotnetCampus_LargeAddressAware_FinalExeFile>
    </PropertyGroup>
    <Error Condition=" $(dotnetCampus_LargeAddressAware_ShouldEditBin)
           And !Exists('$(dotnetCampus_LargeAddressAware_FinalExeFile)') "
           Text="无法开启大内存感知（LargeAddressAware），因为文件“$(dotnetCampus_LargeAddressAware_FinalExeFile)”不存在。" />
    <Exec Condition=" $(dotnetCampus_LargeAddressAware_ShouldEditBin) == true "
          Command="$(dotnetCampus_LargeAddressAware_EditBin) /largeaddressaware &quot;$(dotnetCampus_LargeAddressAware_FinalExeFile)&quot;" />
  </Target>

</Project>